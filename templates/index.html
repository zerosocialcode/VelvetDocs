{% extends "base.html" %}

{% block title %}VelvetDocs - Create Beautiful PDFs{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        text-align: center;
        padding: 2rem 0;
        color: white;
    }
    
    .hero-section h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .hero-section p {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .theme-selector {
        margin-bottom: 2rem;
    }
    
    .theme-card {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        height: 100%;
    }
    
    .theme-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .theme-card.selected {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
    }
    
    .theme-card input[type="radio"] {
        display: none;
    }
    
    .theme-name {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
    }
    
    .theme-description {
        font-size: 0.9rem;
        color: #6b7280;
    }
    
    #contentArea {
        min-height: 400px;
        font-family: 'Courier New', monospace;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
    
    #contentArea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .image-upload-section {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 12px;
        border: 2px dashed #cbd5e1;
        margin-bottom: 1.5rem;
    }
    
    .image-upload-section:hover {
        border-color: var(--primary-color);
        background: #f1f5f9;
    }
    
    .image-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .image-preview-item {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #e5e7eb;
    }
    
    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .image-preview-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .image-preview-item .image-number {
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: rgba(99, 102, 241, 0.9);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .alignment-selector {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .alignment-btn {
        flex: 1;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
    }
    
    .alignment-btn:hover {
        border-color: var(--primary-color);
        background: #f8fafc;
    }
    
    .alignment-btn.active {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
        color: var(--primary-color);
    }
    
    .alert {
        border-radius: 12px;
        border: none;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 2px;
    }
    
    .upload-icon {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <h1>‚ú® Create Beautiful PDFs in Seconds</h1>
    <p>Paste your text, add images, choose a theme, and generate stunning documents</p>
</div>

<!-- Main Card -->
<div class="card">
    <div class="card-body p-4">
        <form id="pdfForm" enctype="multipart/form-data">
            <!-- Theme Selection -->
            <div class="theme-selector">
                <h4 class="mb-3">Choose Your Theme</h4>
                <div class="row g-3">
                    {% for key, name in themes.items() %}
                    <div class="col-md-4">
                        <label class="theme-card" for="theme-{{ key }}">
                            <input type="radio" name="theme" id="theme-{{ key }}" value="{{ key }}" {% if loop.first %}checked{% endif %}>
                            <div class="theme-name">{{ name }}</div>
                            <div class="theme-description">
                                {% if key == 'academic' %}
                                    Traditional serif fonts, perfect for academic papers
                                {% elif key == 'research_pro' %}
                                    Professional research style with structured layout
                                {% elif key == 'modern_colorblock' %}
                                    Bold vibrant colors with contemporary design
                                {% elif key == 'elegant_dark' %}
                                    Sophisticated dark theme with gold accents
                                {% elif key == 'corporate_blue' %}
                                    Professional business document style
                                {% elif key == 'softpastel' %}
                                    Clean minimal design with soft colors
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Image Upload Section -->
            <div class="image-upload-section">
                <div class="text-center">
                    <div class="upload-icon">üì∑</div>
                    <h5 class="mb-2">Add Images to Your PDF</h5>
                    <p class="text-muted mb-3">Upload images and place them in your document using [IMG:0:center]</p>
                    <input type="file" id="imageInput" name="images" multiple accept="image/*" class="d-none">
                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageInput').click()">
                        Choose Images
                    </button>
                </div>
                <div id="imagePreview" class="image-preview"></div>
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>How to use:</strong> Upload images, note their numbers (0, 1, 2...), then use [IMG:0:center] in your text to place image #0 with center alignment. 
                        Alignments: left, center, right
                    </small>
                </div>
            </div>

            <!-- Text Alignment Selection -->
            <div class="mb-4">
                <h5 class="mb-2">Text Alignment</h5>
                <div class="alignment-selector">
                    <button type="button" class="alignment-btn active" data-alignment="left">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/>
                        </svg>
                        Left
                    </button>
                    <button type="button" class="alignment-btn" data-alignment="center">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/>
                        </svg>
                        Center
                    </button>
                    <button type="button" class="alignment-btn" data-alignment="right">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/>
                        </svg>
                        Right
                    </button>
                    <button type="button" class="alignment-btn" data-alignment="justify">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M3 21h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18V7H3v2zm0-6v2h18V3H3z"/>
                        </svg>
                        Justify
                    </button>
                </div>
                <input type="hidden" name="alignment" id="alignmentInput" value="left">
            </div>

            <!-- Text Input -->
            <div class="mb-4">
                <label for="contentArea" class="form-label">
                    <h4 class="mb-2">Your Content</h4>
                    <small class="text-muted">
                        Supports markdown-style formatting: # for headings, **bold**, *italic*, - for lists, > for quotes, [IMG:n:alignment] for images
                    </small>
                </label>
                <textarea 
                    class="form-control" 
                    id="contentArea" 
                    name="content" 
                    placeholder="# My Document Title

## Introduction
This is a **sample** document with *various* formatting options.

[IMG:0:center]

## Key Points
- First important point
- Second important point
- Third important point

> This is a blockquote with important information.

[IMG:1:left]

## Conclusion
Your content will be beautifully formatted in the selected theme!"
                    required
                ></textarea>
            </div>

            <!-- Alert Area -->
            <div id="alertArea"></div>

            <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                    <span id="btnText">Generate PDF</span>
                    <span id="btnSpinner" class="d-none">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Generating...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Example Section -->
<div class="card mt-4">
    <div class="card-body">
        <h5>üìù Formatting Guide</h5>
        <div class="row mt-3">
            <div class="col-md-6">
                <p><strong>Headings:</strong></p>
                <code># Heading 1<br>## Heading 2<br>### Heading 3</code>
            </div>
            <div class="col-md-6">
                <p><strong>Text Formatting:</strong></p>
                <code>**bold text**<br>*italic text*</code>
            </div>
            <div class="col-md-6 mt-3">
                <p><strong>Lists:</strong></p>
                <code>- List item 1<br>- List item 2</code>
            </div>
            <div class="col-md-6 mt-3">
                <p><strong>Blockquotes:</strong></p>
                <code>> Important quote</code>
            </div>
            <div class="col-md-6 mt-3">
                <p><strong>Images:</strong></p>
                <code>[IMG:0:center]<br>[IMG:1:left]<br>[IMG:2:right]</code>
            </div>
            <div class="col-md-6 mt-3">
                <p><strong>Image Numbers:</strong></p>
                <code>First uploaded = 0<br>Second uploaded = 1<br>Third uploaded = 2</code>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFiles = [];

// Theme selection interaction
document.querySelectorAll('.theme-card').forEach(card => {
    card.addEventListener('click', function() {
        document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        this.querySelector('input[type="radio"]').checked = true;
    });
});

// Initialize first theme as selected
document.querySelector('.theme-card').classList.add('selected');

// Alignment button interaction
document.querySelectorAll('.alignment-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.alignment-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('alignmentInput').value = this.dataset.alignment;
    });
});

// Image upload handling
document.getElementById('imageInput').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    selectedFiles = selectedFiles.concat(files);
    updateImagePreview();
});

function updateImagePreview() {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'image-preview-item';
            div.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button type="button" class="remove-btn" onclick="removeImage(${index})">√ó</button>
                <div class="image-number">${index}</div>
            `;
            preview.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedFiles.splice(index, 1);
    updateImagePreview();
}

// Form submission
document.getElementById('pdfForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    
    // Add text content
    formData.append('content', document.getElementById('contentArea').value);
    
    // Add theme
    const selectedTheme = document.querySelector('input[name="theme"]:checked');
    formData.append('theme', selectedTheme.value);
    
    // Add alignment
    formData.append('alignment', document.getElementById('alignmentInput').value);
    
    // Add images
    selectedFiles.forEach(file => {
        formData.append('images', file);
    });
    
    const generateBtn = document.getElementById('generateBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const alertArea = document.getElementById('alertArea');
    
    // Show loading state
    generateBtn.disabled = true;
    btnText.classList.add('d-none');
    btnSpinner.classList.remove('d-none');
    alertArea.innerHTML = '';
    
    try {
        const response = await fetch('/generate', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Show success message
            alertArea.innerHTML = `
                <div class="alert alert-success">
                    <strong>Success!</strong> Your PDF has been generated.
                    <a href="/download/${data.filename}" class="alert-link ms-2">Download Now</a>
                    <span class="mx-2">|</span>
                    <a href="/preview/${data.filename}" class="alert-link">Preview</a>
                </div>
            `;
            
            // Auto download
            setTimeout(() => {
                window.location.href = `/download/${data.filename}`;
            }, 500);
        } else {
            throw new Error(data.error || 'Failed to generate PDF');
        }
    } catch (error) {
        alertArea.innerHTML = `
            <div class="alert alert-danger">
                <strong>Error!</strong> ${error.message}
            </div>
        `;
    } finally {
        // Reset button state
        generateBtn.disabled = false;
        btnText.classList.remove('d-none');
        btnSpinner.classList.add('d-none');
    }
});
</script>
{% endblock %}
